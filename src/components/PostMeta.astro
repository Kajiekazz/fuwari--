---
import { Icon } from "astro-icon/components";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import { formatDateToYYYYMMDD } from "../utils/date-utils";
import { getCategoryUrl, getTagUrl } from "../utils/url-utils";
import { statsConfig } from "../config"; // ç§»é™¤ umamiConfigï¼Œåœ¨ script é‡Œå¼•å…¥

interface Props {
	class: string;
	published: Date;
	updated?: Date;
	tags: string[];
	category: string | null;
	hideTagsForMobile?: boolean;
	hideUpdateDate?: boolean;
    slug?: string;
}
const {
	published,
	updated,
	tags,
	category,
	hideTagsForMobile = false,
	hideUpdateDate = false,
    slug,
} = Astro.props;
const className = Astro.props.class;
---

<div class:list={["flex flex-wrap text-neutral-500 dark:text-neutral-400 items-center gap-4 gap-x-4 gap-y-2", className]}>
    <!-- ... (å‰é¢çš„æ—¥æœŸã€åˆ†ç±»ã€æ ‡ç­¾ä»£ç ä¿æŒä¸å˜ï¼Œçœç•¥ä»¥èŠ‚çœç©ºé—´) ... -->
    <!-- ... è¯·ä¿ç•™åŸæœ‰çš„æ—¥æœŸå’Œæ ‡ç­¾ä»£ç  ... -->
    
    <!-- publish date -->
    <div class="flex items-center">
        <div class="meta-icon">
            <Icon name="material-symbols:calendar-today-outline-rounded" class="text-xl"></Icon>
        </div>
        <span class="text-50 text-sm font-medium">{formatDateToYYYYMMDD(published)}</span>
    </div>

    <!-- update date -->
    {!hideUpdateDate && updated && updated.getTime() !== published.getTime() && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:edit-calendar-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">{formatDateToYYYYMMDD(updated)}</span>
        </div>
    )}

    <!-- categories -->
    <div class="flex items-center">
        <div class="meta-icon">
            <Icon name="material-symbols:book-2-outline-rounded" class="text-xl"></Icon>
        </div>
        <div class="flex flex-row flex-nowrap items-center">
            <a href={getCategoryUrl(category)} aria-label={`View all posts in the ${category} category`}
               class="link-lg transition text-50 text-sm font-medium
                            hover:text-[var(--primary)] dark:hover:text-[var(--primary)] whitespace-nowrap">
                {category || i18n(I18nKey.uncategorized)}
            </a>
        </div>
    </div>

    <!-- tags -->
    <div class:list={["items-center", {"flex": !hideTagsForMobile, "hidden md:flex": hideTagsForMobile}]}>
        <div class="meta-icon">
            <Icon name="material-symbols:tag-rounded" class="text-xl"></Icon>
        </div>
        <div class="flex flex-row flex-nowrap items-center">
            {(tags && tags.length > 0) && tags.map((tag, i) => (
                <div class:list={[{"hidden": i == 0}, "mx-1.5 text-[var(--meta-divider)] text-sm"]}>/</div>
                <a href={getTagUrl(tag)} aria-label={`View all posts with the ${tag.trim()} tag`}
                   class="link-lg transition text-50 text-sm font-medium
                                hover:text-[var(--primary)] dark:hover:text-[var(--primary)] whitespace-nowrap">
                    {tag.trim()}
                </a>
            ))}
            {!(tags && tags.length > 0) && <div class="transition text-50 text-sm font-medium">{i18n(I18nKey.noTags)}</div>}
        </div>
    </div>

    <!-- page views -->
    {slug && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:visibility-outline-rounded" class="text-xl"></Icon>
            </div>
            <!-- ğŸ‘‡ ä¿®æ”¹ç‚¹ï¼šå¢åŠ äº† data-slug å±æ€§ï¼Œå»æ‰äº† id -->
            <span class="text-50 text-sm font-medium umami-views-meta" data-slug={slug}>
                {statsConfig.loadingText}
            </span>
        </div>
    )}
</div>

<!-- ğŸ‘‡ ä¿®æ”¹ç‚¹ï¼šå®Œå…¨é‡å†™äº† Scriptï¼Œå»æ‰äº† define:vars -->
<script>
    import { umamiConfig, statsConfig } from "../config";
    import { getUmamiShareData, clearUmamiShareCache } from "../utils/umami";

    function generateStatsText(pageViews: number, visits: number) {
        return `${statsConfig.viewsText} ${pageViews} Â· ${statsConfig.visitsText} ${visits}`;
    }

    async function fetchPageViews() {
        if (!umamiConfig.enable) return;

        const displayElement = document.querySelector('.umami-views-meta');
        // å¦‚æœé¡µé¢ä¸Šæ²¡æœ‰è¿™ä¸ªå…ƒç´ ï¼Œç›´æ¥è¿”å›
        if (!displayElement || !(displayElement instanceof HTMLElement)) return;

        const slug = displayElement.dataset.slug;
        if (!slug) return;

        try {
            const { token } = await getUmamiShareData(umamiConfig.baseUrl, umamiConfig.shareId);
            const websiteId = umamiConfig.websiteId;
            const currentTimestamp = Date.now();
            
            // åŠ ä¸Š /analytics/eu
            const statsUrl = `${umamiConfig.baseUrl}/analytics/eu/api/websites/${websiteId}/stats?startAt=0&endAt=${currentTimestamp}&unit=hour&timezone=${encodeURIComponent(umamiConfig.timezone)}&url=${encodeURIComponent('/posts/' + slug + '/')}`;

            const headers: Record<string, string> = {};
            if (token) headers['x-umami-share-token'] = token;

            const statsResponse = await fetch(statsUrl, { headers });

            if (statsResponse.status === 401) {
                clearUmamiShareCache();
                // ç®€å•é‡è¯•ä¸€æ¬¡ï¼Œé˜²æ­¢æ­»å¾ªç¯
                return; 
            }

            if (!statsResponse.ok) throw new Error('API Error');

            const statsData = await statsResponse.json();
            const pageViews = statsData.pageviews?.value || statsData.pageviews || 0;
            const visits = statsData.visitors?.value || statsData.visitors || 0;

            displayElement.textContent = generateStatsText(pageViews, visits);

        } catch (error) {
            console.error('Error fetching page views:', error);
            displayElement.textContent = statsConfig.unavailableText;
        }
    }

    // Astro çš„ View Transitions å…¼å®¹
    document.addEventListener('astro:page-load', fetchPageViews);
    // æ™®é€šåŠ è½½å…¼å®¹
    document.addEventListener('DOMContentLoaded', fetchPageViews);
</script>